<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invoice — Void PC Games</title>
  
<style>
  /* Try to remove browser print header/footer margins (may not remove URL in all browsers) */
  @page { margin: 0; }
  @media print {
    html, body { margin: 0; padding: 0; }
    /* Keep the invoice content visible and remove extra spacing */
    .invoice-wrap { box-shadow:none !important; border:none !important; padding: 12mm !important; }
  }

  /* Hide common live-reload / dev overlays that some servers inject */
  #__liveServerOverlay, #LiveServerMessage, #livereload, .livereload, .vite { display: none !important; }

  /* Hide any small debug/status element (if it has an id/class you can change these selectors) */
  .dev-status, .server-status, .debug-footer { display: none !important; }

  /* If the URL is being printed by the browser's "header/footer", the only reliable solution
     is to disable headers/footers from the print dialog (Chrome/Edge/Firefox). */
</style>


  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Print rules */
    @media print {
      body { margin:0; padding:0; }
      .no-print { display:none !important; }
      .invoice-wrap { box-shadow:none !important; margin:0 !important; border:none !important; padding:0 1rem !important; }
    }

    /* small visual tweaks */
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f6f8fb; }
    .invoice-wrap { max-width:900px; width:100%; background:#fff; border-radius:10px; padding:30px; box-shadow: 0 12px 40px rgba(20,30,60,0.06); border:1px solid rgba(14,20,40,0.03); }
    .brand-badge { display:inline-block; padding:10px 12px; border-radius:12px; background:linear-gradient(180deg,#fff,#f7fafb); border:1px solid rgba(0,0,0,0.04); box-shadow:0 4px 10px rgba(0,0,0,0.03); font-weight:700; color:#0f172a; }
    .paid-pill { display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border-radius:999px; background:linear-gradient(180deg,#ecfdf5,#d1fae5); color:#065f46; font-weight:800; border:1px solid rgba(6,95,70,0.12); box-shadow: 0 6px 18px rgba(16,163,127,0.06); }
    .value-strong { font-weight:800; color:#2b6cb0; }
    .muted { color:#6b7280; }
    .table-head { text-transform:uppercase; font-weight:700; color:#475569; font-size:12px; letter-spacing:.6px; }
    .qr-img { width:160px; height:160px; object-fit:cover; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.06); border:6px solid #fff; }
    .invoice-id { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; color:#374151; }
    .total-box { background: linear-gradient(180deg,#fff,#f5f7ff); border-radius:10px; padding:18px; border:1px solid rgba(59,130,246,0.12); }
    .divider { height:1px; background:linear-gradient(90deg, rgba(99,102,241,0.06), rgba(79,70,229,0.06)); margin:20px 0; border-radius:2px; }

    /* mobile tweaks */
    @media (max-width:640px){
      .invoice-grid { display:block; }
      .invoice-wrap { padding:18px; }
      .qr-img { width:140px; height:140px; }
    }
  </style>
</head>
<body class="min-h-screen p-6 sm:p-12 flex flex-col items-center">

  <!-- top controls (no-print) -->
  <div class="w-full max-w-3xl mb-6 no-print">
    <div class="flex gap-3 items-center">
      <input id="rowInput" type="number" min="2" value="2" class="flex-1 p-3 border rounded-lg shadow-sm" placeholder="Enter row number (start 2)" />
      <button id="genBtn" class="px-5 py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Generate Invoice</button>
      <button id="printBtn" class="px-4 py-3 rounded-lg bg-green-600 text-white hidden">Print</button>
    </div>
    <p id="statusMsg" class="mt-3 text-sm text-gray-600"></p>
  </div>

  <!-- invoice -->
  <div id="invoiceWrap" class="invoice-wrap w-full">
    <!-- Header -->
    <div class="flex justify-between items-start gap-6">
      <div>
        <div class="text-5xl font-extrabold text-indigo-700">INVOICE</div>
        <div class="mt-3 text-sm invoice-id">Invoice ID: <span id="invoiceId">INV-00001</span></div>
      </div>

      <div class="text-right">
        <div class="brand-badge inline-flex items-center gap-3">
          <img id="logoImg" src="https://i.ibb.co/sJqfn3w5/1761541971985.png" alt="logo" class="w-10 h-10 rounded-md object-cover" />
          <div class="text-left">
            <div class="font-bold text-gray-800">Void PC Games</div>
            <div class="text-xs muted">Generated on: <span id="generatedOn">--</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- billed to / details -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start invoice-grid">
      <div class="md:col-span-2">
        <div class="p-4 rounded-lg border border-gray-100 bg-gray-50">
          <div class="mb-3 font-semibold text-indigo-700">Billed To</div>
          <div class="text-sm">Customer Name: <span id="custName" class="font-semibold text-gray-900">-</span></div>
          <div class="text-sm mt-1 muted">Transaction Time: <span id="txTime">-</span></div>
          <div class="text-sm mt-1">Payment Status: <span id="payStatus" class="font-semibold">-</span></div>
        </div>

        <div class="mt-6 overflow-hidden rounded-lg border border-gray-100">
          <table class="w-full">
            <thead class="bg-white table-head">
              <tr>
                <th class="text-left px-6 py-3">Description</th>
                <th class="text-right px-6 py-3">Unit Price</th>
                <th class="text-right px-6 py-3">Qty</th>
                <th class="text-right px-6 py-3">Amount</th>
              </tr>
            </thead>
            <tbody class="bg-white">
              <tr>
                <td id="descTd" class="px-6 py-6 text-gray-800">-</td>
                <td id="unitTd" class="px-6 py-6 text-right muted">-</td>
                <td class="px-6 py-6 text-right muted">1</td>
                <td id="amountTd" class="px-6 py-6 text-right font-extrabold text-indigo-700">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- QR / payment panel -->
      <div class="flex flex-col items-center gap-6">
        <div id="paymentPanel" class="w-full p-4 rounded-lg border border-gray-100 bg-white flex flex-col items-center">
          <!-- content replaced dynamically -->
        </div>

        <div class="w-full total-box">
          <div class="flex justify-between text-sm muted mb-2">
            <span>Subtotal:</span><span id="subtotal">₹0.00</span>
          </div>
          <div class="flex justify-between text-sm muted mb-4">
            <span>Platform Fees:</span><span id="platformFeesDisplay">₹0.00</span>
          </div>
          <div class="flex justify-between items-center">
            <div class="text-sm muted">TOTAL</div>
            <div class="text-2xl font-extrabold text-indigo-700" id="totalAmount">₹0.00</div>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="text-xs muted text-center">Thank You For Purchasing From Us. For Any Queries, Please Contact Void PC Games</div>
  </div>

  <script>
    // ---------- CONFIG ----------
    // Replace with your Apps Script URL if you have a working endpoint
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0TbFbHSaoL5oYYJ1lYw71MetO6Pyyy-nVra48qv-d5liDXV-HmCZJBl7MtxfcJ6nVLg/exec";

    // fallback data sample
    const FALLBACK = [
      { Timestamp:"2025-10-23 16:50:30Z", "NAME OF CUSTOMER":"tarunendra_vishwakara016", "PRODUCT NAME":"spiderman", "PRODUCT BUY PRICE":0, "PRODUCT SELL PRICE":70, "PAYMENT STATUS":"Paid", "PROFITS":70, "QR Code Url":"https://i.ibb.co/B56cpnDr/Navi-QR-RAMESH-RAISING-CHAVAN-23102025223920205.png", "Platform Fees": "" },
      { Timestamp:"2025-10-27 14:57:46", "NAME OF CUSTOMER":"_virendra_7777", "PRODUCT NAME":"GTA V", "PRODUCT BUY PRICE":199, "PRODUCT SELL PRICE":300, "PAYMENT STATUS":"Paid", "PROFITS":101, "QR Code Url":"", "Platform Fees": "" },
      { Timestamp:"2025-10-27 19:43:31", "NAME OF CUSTOMER":"_mj__gaming", "PRODUCT NAME":"Netflix", "PRODUCT BUY PRICE":129, "PRODUCT SELL PRICE":149, "PAYMENT STATUS":"Pending", "PROFITS":20, "QR Code Url":"https://placehold.co/200x200/000000/ffffff?text=QR", "Platform Fees": "" },
      { Timestamp:"2025-10-28 16:14:01", "NAME OF CUSTOMER":"_mj__gaming", "PRODUCT NAME":"Spider-man 2", "PRODUCT BUY PRICE":199, "PRODUCT SELL PRICE":250, "PAYMENT STATUS":"Pending", "PROFITS":51, "QR Code Url":"https://placehold.co/200x200/000000/ffffff?text=QR", "Platform Fees": 0 }
    ];

    const STATIC_QR = "https://i.ibb.co/B56cpnDr/Navi-QR-RAMESH-RAISING-CHAVAN-23102025223920205.png";
    const UPI_ID = "viraj69rip@ybl";

    // ---------- helpers ----------
    function el(id){ return document.getElementById(id); }
    function fmtINR(n){ return "₹" + Number(n||0).toLocaleString("en-IN",{minimumFractionDigits:2}); }
    function nowStr(){ return (new Date()).toLocaleString(); }
    function normalizeStatus(s){ if(!s) return ""; return String(s).trim().toLowerCase(); }

    // layout elements
    const statusMsg = el('statusMsg');
    const rowInput = el('rowInput');
    const genBtn = el('genBtn');
    const printBtn = el('printBtn');

    // invoice fields
    const invoiceIdEl = el('invoiceId');
    const generatedOnEl = el('generatedOn');
    const custNameEl = el('custName');
    const txTimeEl = el('txTime');
    const payStatusEl = el('payStatus');
    const descTd = el('descTd');
    const unitTd = el('unitTd');
    const amountTd = el('amountTd');
    const subtotalEl = el('subtotal');
    const totalEl = el('totalAmount');
    const platformFeesDisplay = el('platformFeesDisplay');
    const paymentPanel = el('paymentPanel');
    const logoImg = el('logoImg');

    // ---------- utility to read platform fees safely ----------
    function readPlatformFees(record){
      const keys = ['Platform Fees','PlatformFees','platform fees','platform_fees','Platform_Fees','platformFees','Platform Fee','Platform_fee','platformfee'];
      for(const k of keys){
        if(record && Object.prototype.hasOwnProperty.call(record,k)){
          const v = record[k];
          if(v === "" || v === null || v === undefined) return 0;
          const num = Number(String(v).replace(/[^0-9.\-]/g,'')); // try sanitize
          return isNaN(num) ? 0 : num;
        }
      }
      // fallback if none present
      return 0;
    }

    // ---------- render functions ----------
    function renderPaymentBlock(record, finalAmount){
      const status = normalizeStatus(record['PAYMENT STATUS'] || record['Payment Status'] || record['status'] || "");
      const isPaid = status.includes('paid') || status.includes('completed') || status.includes('success');

      // clear
      paymentPanel.innerHTML = "";

      if(isPaid){
        // show improved paid badge and a small thank-you message
        const wrapper = document.createElement('div');
        wrapper.className = "w-full flex flex-col items-center p-4";
        wrapper.innerHTML = `
          <div class="paid-pill mb-3">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M20 6L9 17l-5-5" stroke="#065f46" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>PAID</span>
          </div>
          <div class="text-sm text-gray-600 text-center">Payment received — thank you for your purchase!</div>
        `;
        paymentPanel.appendChild(wrapper);
      } else {
        // pending -> show QR + UPI + amount
        const qrUrl = record['QR Code Url'] || record['QR'] || STATIC_QR;
        const wrapper = document.createElement('div');
        wrapper.className = "w-full flex flex-col items-center p-4";
        wrapper.innerHTML = `
          <div class="text-sm font-semibold mb-2">Scan to Pay (UPI)</div>
          <div class="text-indigo-700 font-bold mb-2">Total Due: ${finalAmount}</div>
          <a href="${qrUrl}" target="_blank" rel="noopener noreferrer" class="block mb-3">
            <img src="${qrUrl}" alt="QR" class="qr-img" onerror="this.onerror=null; this.src='${STATIC_QR}';" />
          </a>
          <div class="text-sm font-semibold">${UPI_ID}</div>
        `;
        paymentPanel.appendChild(wrapper);
      }
    }

    function renderInvoiceFromRecord(rowNumber, record){
      // invoice id
      invoiceIdEl.textContent = "INV-" + String(rowNumber).padStart(5,'0');
      generatedOnEl.textContent = nowStr();

      const cust = record['NAME OF CUSTOMER'] || record['Name'] || record['NAME'] || "Unknown";
      custNameEl.textContent = cust;

      const ts = record['Timestamp'] || record['Date'] || "";
      txTimeEl.textContent = ts;

      const paymentStatusText = record['PAYMENT STATUS'] || record['Payment Status'] || record['status'] || "";
      payStatusEl.textContent = paymentStatusText || "Pending";

      const product = record['PRODUCT NAME'] || record['Product'] || "Product";
      descTd.textContent = product;

      const sell = Number(record['PRODUCT SELL PRICE'] ?? record['PRODUCT_SELL_PRICE'] ?? record['PRODUCTSELLPRICE'] ?? 0);
      unitTd.textContent = fmtINR(sell);
      amountTd.textContent = fmtINR(sell);
      subtotalEl.textContent = fmtINR(sell);

      // read platform fees safely (default 0)
      const pf = readPlatformFees(record);
      platformFeesDisplay.textContent = fmtINR(pf);

      // keep total as sell price (unchanged). If you want total = sell - platform fees, tell me.
      totalEl.textContent = fmtINR(sell);

      renderPaymentBlock(record, fmtINR(sell));
      printBtn.classList.remove('hidden');
    }

    // ---------- data load ----------
    async function fetchDataArray(){
      statusMsg.textContent = "Fetching live data...";
      try {
        const res = await fetch(APPS_SCRIPT_URL, {cache: "no-store"});
        if(!res.ok) throw new Error("Bad status " + res.status);
        const json = await res.json();
        // try common structure
        let arr = json['data-a'] || json.data || json.rows || json;
        // if object, try to convert to array of values
        if(arr && typeof arr === 'object' && !Array.isArray(arr)){
          const maybe = Object.values(arr).filter(v => typeof v === 'object');
          if(maybe.length) arr = maybe;
        }
        if(!Array.isArray(arr) || arr.length === 0) throw new Error("No rows in response");
        statusMsg.textContent = "Live data loaded (" + arr.length + " rows).";
        return arr;
      } catch(err) {
        console.warn("Live fetch failed:", err);
        statusMsg.textContent = "Using fallback sample data (live fetch failed).";
        return FALLBACK;
      }
    }

    // ---------- main flow ----------
    async function generateForRow(rowNumber){
      const data = await fetchDataArray();
      const idx = rowNumber - 2; // sheet / form responses first data row is 2
      if(idx < 0 || idx >= data.length){
        statusMsg.textContent = "Row out of range. Available rows: 2 - " + (data.length + 1);
        return;
      }
      const rec = data[idx];
      renderInvoiceFromRecord(rowNumber, rec);
      statusMsg.textContent = "Invoice generated from row " + rowNumber + ".";
    }

    // click handlers
    genBtn.addEventListener('click', function(){
      const v = parseInt(rowInput.value,10);
      if(!Number.isInteger(v) || v < 2){
        statusMsg.textContent = "Enter a valid row number (start from 2).";
        return;
      }
      generateForRow(v);
    });

    printBtn.addEventListener('click', function(){
      window.print();
    });

    // support query string ?row=NN
    (function initFromQuery(){
      const params = new URLSearchParams(window.location.search);
      const q = params.get('row');
      if(q){
        const rn = parseInt(q,10);
        if(Number.isInteger(rn) && rn >= 2){
          rowInput.value = rn;
          // auto-generate
          generateForRow(rn);
        }
      }
    })();

    // on load, set some defaults
    generatedOnEl.textContent = nowStr();
  </script>

</body>
</html>
